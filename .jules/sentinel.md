# Sentinel Security Journal

## 2025-01-12 - Disk Exhaustion Protection in Subprocesses
**Vulnerability:** The backend executed external commands (`make`, `make run`) using `subprocess.Popen` with output redirected to a temporary file (`tempfile.TemporaryFile`). There was no limit on the size of this file. A malicious or buggy simulation could write infinite data to stdout, filling the server's disk space and causing a Denial of Service (DoS).
**Learning:** `subprocess.Popen` with `stdout=file_obj` writes directly to the file descriptor, bypassing Python-level buffering. While efficient, it lacks built-in size limits. Standard resource limits (`ulimit` / `setrlimit`) affect *all* file writes, which is unsuitable for build processes that legitimately produce large artifacts (binaries, object files) but need to limit only the log output.
**Prevention:** Implemented a polling loop in `run_command_safe` that periodically checks `os.fstat(fd).st_size`. If the limit (10MB) is exceeded, the process group is terminated. Crucially, I added a "post-mortem" check after the process exits to catch fast-running processes that might exceed the limit between poll intervals. Additionally, improved error handling to ensure the partial log (containing the error message) is returned to the user even when the process is killed.

## 2026-01-13 - Path Disclosure Mitigation
**Vulnerability:** The `list_cases` endpoint returned absolute file system paths (e.g., `/home/user/app/my_cases/Case1`) to the frontend. This exposed the server's directory structure, username, and installation path, which helps attackers map the system (Information Disclosure).
**Learning:** Returning absolute paths is often unnecessary and risky. Backend APIs should abstract the underlying filesystem. However, legacy endpoints or internal logic might rely on absolute paths (like `validate_case_path` utilizing `os.path.realpath`). Changing to relative paths required ensuring the validation logic could transparently handle both absolute (for internal backward compatibility) and relative paths.
**Prevention:** Modified the API to return paths relative to a defined root (`CASES_DIR`). Updated the input validation (`validate_case_path`) to automatically anchor incoming relative paths to this root before verification. This minimizes information leakage while maintaining functionality.

## 2026-01-14 - DNS Rebinding Protection via Trusted Hosts
**Vulnerability:** The application was vulnerable to DNS Rebinding attacks because it did not validate the `Host` header. This allows external websites to bypass the Same-Origin Policy and access internal API endpoints (like `/cases`) if the user visits a malicious site resolving to `127.0.0.1`. Even though the app binds to localhost, it is reachable via any hostname resolving to that IP.
**Learning:** `uvicorn` and `fastapi` do not validate the `Host` header by default. Relying solely on network binding (localhost) is insufficient for web-based attacks like DNS Rebinding.
**Prevention:** Implemented `TrustedHostMiddleware` to explicitly whitelist allowed hostnames (`localhost`, `127.0.0.1`). This ensures the server rejects requests with malicious `Host` headers, effectively neutralizing the attack vector.
